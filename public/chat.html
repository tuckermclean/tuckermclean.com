<style>
    #window-chat .window-body {
        margin: 0;
        padding: 0;
    }

    #chat-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    #chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border);
    }
    #chat-options {
        display: flex;
        padding: 0.75rem;
    }

    input, textarea, button {
        font-family: inherit;
        font-size: inherit;
        color: inherit;
        background-color: inherit;
        border: none;
        outline: none;
    }

    input, textarea {
        margin-right: 0.75rem;
        padding: 0.325rem;
        border: 1px solid var(--border);
        border-radius: 0.325rem;
        color: var(--text);
        background-color: var(--bg);
    }

    #chat-submit {
        display: flex;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    #chat-submit textarea {
        width: 100%;
        min-height: 15vh;
    }

    button {
        padding: 0.325rem 1rem;
        background-color: var(--header-bg);
        background: var(--header-bg-gradient);
        color: var(--header-text);
        border: 1px solid var(--border);
        border-radius: 0.325rem;
        cursor: pointer;
    }

    button:hover {
        background: var(--button-bg-gradient-hover);
    }
    button:active {
        background: var(--button-bg-gradient-active);
    }
    #chat-container button:hover {
        background-color: var(--scroll-hover);
    }
</style>
<div id="chat-messages"></div>
<div id="chat-submit">
    <textarea id="message" placeholder="Type your message"></textarea>
    <button onclick="sendMessage()">Send</button>
</div>
<div id="chat-options">
    <input type="text" id="name" placeholder="Your name (required)">
    <input type="email" id="email" placeholder="Your email (pick one, option 1)">
    <input type="phone" id="phone" placeholder="Your phone number (pick one, option 2)">
</div>

<script>
    const apiBaseUrl = "https://api.technomantics.com/v1/conversation";
    
    // Set up Enter key to send message
    document.getElementById("message").addEventListener("keydown", (event) => {
        // If the key is Enter but without any modifiers, send the message
        if (event.key === "Enter" && !event.shiftKey && !event.ctrlKey && !event.altKey) {
            event.preventDefault();
            sendMessage();
        }
    });
    // If user types in name, email, or phone, save it to local storage
    document.getElementById("name").addEventListener("input", (event) => {
        localStorage.setItem("name", event.target.value);
    });
    document.getElementById("email").addEventListener("input", (event) => {
        localStorage.setItem("email", event.target.value);
    });
    document.getElementById("phone").addEventListener("input", (event) => {
        localStorage.setItem("phone", event.target.value);
    });

    // Read from the local storage, but if it's not there, generate one
    const conversationUuid = localStorage.getItem("conversationUuid") || uuidv4();
    const authHeader = localStorage.getItem("authHeader") || null;

    // Save the conversation UUID and auth header to local storage
    if (!localStorage.getItem("conversationUuid") && conversationUuid) {
        localStorage.setItem("conversationUuid", conversationUuid);
    }
    if (!localStorage.getItem("authHeader") && authHeader) {
        localStorage.setItem("authHeader", authHeader);
    }
    const name = localStorage.getItem("name") || null;
    const email = localStorage.getItem("email") || null;
    const phone = localStorage.getItem("phone") || null;

    if (name) {
        document.getElementById("name").value = name;
    }
    if (email) {
        document.getElementById("email").value = email;
    }
    if (phone) {
        document.getElementById("phone").value = phone;
    }

    //const authHeader = "Basic dXNlcjpwYXNz"; // Replace with your basic auth string
    async function fetchMessages(since = null) {
        try {
            let url = `${apiBaseUrl}/${conversationUuid}`;
            if (since) {
                url = `${url}?since=${since}`;
            }
            const response = await fetch(url, {
                method: "GET",
            });
            const messages = await response.json();
            displayMessages(messages);
        } catch (error) {
            console.error("Error fetching messages:", error);
        }
    }
    
    async function fetchNewMessages() {
        const messagesContainer = document.getElementById("chat-messages");
        const lastMessage = messagesContainer.lastChild;
        const lastMessageTimestamp = lastMessage ? lastMessage.textContent.split("]")[0].slice(1) : null;
        fetchMessages(lastMessageTimestamp);
    }
    
    function displayMessages(messages) {
        const messagesContainer = document.getElementById("chat-messages");
        //messagesContainer.innerHTML = ""; // Clear existing messages
        
        messages.forEach((msg) => {
            const messageDiv = document.createElement("div");
            const senderInfo = msg.name || msg.email || msg.phone || msg.authenticated_user_info || "Anonymous";
            messageDiv.textContent = `[${msg.timestamp}] ${senderInfo}: ${msg.message}`;
            if (msg.authenticated_user_info && msg.authenticated_user_info !== null) {
                messageDiv.style.fontWeight = "bold";
            }
            messagesContainer.appendChild(messageDiv);
        });
        
        // Scroll to the bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    async function sendMessage() {
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const message = document.getElementById("message").value;
        
        if (!message) {
            alert("Message cannot be empty.");
            return;
        }
        
        const payload = {
            message,
            ...(name && { name }),
            ...(email && { email }),
        };
        
        try {
            const response = await fetch(`${apiBaseUrl}/${conversationUuid}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(authHeader && { Authorization: authHeader }),
                },
                body: JSON.stringify(payload),
            });
            
            const result = await response.json();
            if (response.ok) {
                document.getElementById("message").value = ""; // Clear the input
                fetchNewMessages(); // Refresh the chat
            } else {
                alert(`Error: ${result.error || "Could not send message"}`);
            }
        } catch (error) {
            console.error("Error sending message:", error);
        }
    }
    
    // Load messages on page load
    fetchMessages();
    
    // Refresh messages every 5 seconds
    setInterval(fetchNewMessages, 5000);
</script>
